---
title: "Racial Disparities in School Discipline: Explorer Dashboard"
author: Brittany Spinner
output:
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bg: "#a1a1a1"
      fg: "#303333"
      primary: "#e5de54"
      navbar-bg: "#808c73"
      base_font: 
        google: Prompt
      heading_font:
        google: Sen
      code_font:
        google: 
          # arguments to sass::font_google() 
          family: Seaford
          local: false
---

```{r setup, include = FALSE}

brand_colors <- list(
  dark_gray = "#303333",  # PMS 179-15-C
  yellow = "#e5de54",     # PMS 1-15 C
  sage = "#808c73",       # PMS 178-8 C
  gray = "#a1a1a1",       # PMS 179-7 C
  light_gray = "#bdbfbf"  # PMS 175-2 C
)


library(flexdashboard)
library(shiny)
library(jsonlite)
# library(maptools)
library(ggplot2)
library(tidyr)
library(dplyr)
library(purrr)
library(leaflet)
library(plotly)
library(rio)
library(forecast)  # For time-series analysis
library(DT)


```

## Column 

### States that ave Adopted Corp Punishment and not Since 2020

```{r}

library(tibble)
# windowsFonts(Seaford = windowsFont("Seaford")) 

library(showtext)
library(extrafont)

# Manually add Seaford (update with the correct font path)
font_add("Seaford", "~/Library/Group Containers/UBF8T346G9.Office/FontCache/4/CloudFonts/Seaford/19722397430.ttf")  
# Enable showtext rendering
showtext_auto()
#===============================
# Brand Color Definitions
#===============================
brand_colors <- list(
  dark_gray = "#303333",  # PMS 179-15-C
  yellow = "#e5de54",     # PMS 1-15 C
  sage = "#808c73",       # PMS 178-8 C
  gray = "#a1a1a1",       # PMS 179-7 C
  light_gray = "#bdbfbf"  # PMS 175-2 C
)

#===============================
# Color Palette Function
#===============================
brand_palette <- function(n = 5) {
  colors <- c(brand_colors$dark_gray, 
              brand_colors$yellow,
              brand_colors$sage,
              brand_colors$gray,
              brand_colors$light_gray)
  colors[1:n]
}

#===============================
# Brand Theme Definition
#===============================
theme_brand <- function(base_size = 12) {
  theme_minimal(base_size = base_size) %+replace%
    theme(
      # Text elements
      text = element_text(family = "Seaford"),  # Seaford
      plot.title = element_text(
        size = rel(1.2), 
        face = "bold"
      ),
      plot.subtitle = element_text(
        size = rel(1)
      ),
      axis.title = element_text(
        face = "bold"
      ),
      
      # Grid elements
      panel.grid.major = element_line(color = brand_colors$light_gray),
      panel.grid.minor = element_blank(),
      
      # Legend
      legend.position = "bottom"
    )
}

#===============================
# Scale Functions
#===============================
# For categorical colors
scale_fill_brand <- function(...) {
  scale_fill_manual(values = brand_palette(), ...)
}

scale_color_brand <- function(...) {
  scale_color_manual(values = brand_palette(), ...)
}

```


```{r, fig.width=40, fig.height=24}
## Read in data 
library(here)
library(rio)

df1 <- import(here("data/corp_76to20_bystate_MGyearrecoded.xlsx"))
df2 <- import(here("data/suspensions_72to21_bystate_MGyearrecoded.xlsx"))
df3 <- import(here("data/treatment dataset_2year.xlsx"))


# YEAR ranges from 1972-2020

df_corp <- df3 %>%
  filter(YEAR > 2020) %>%
  group_by(STATE_CODE)

library(maps)

us_states <- map_data("state") 

# Convert state names to lowercase for merging
us_states$region <- tolower(us_states$region)

### Create a lookup table for state abbreviations and full names
state_lookup <- data.frame(STATE_CODE = state.abb, region = tolower(state.name))

### Merge df_map with full state names
df_corp <- left_join(df_corp, state_lookup, by = "STATE_CODE")

## STATE_CODE has 51 states DC is counted as a state, but shows up as NA ## in region

## recoded region's NAs to be DC, dc
# unique(df_corp$STATE_CODE)
# unique(df_corp$region)
df_corp$region <- if_else(is.na(df_corp$region), "dc", df_corp$region)

# unique(us_states$region)
  
## Merge with map data
us_states <- left_join(us_states, df_corp, by = "region")


color_palette <- list(yellow = "#e5de54", # not adopted 
                   dark_gray = "#808c73") # adopted
map_color_palette <- c("0" = color_palette$yellow, "1" = color_palette$dark_gray)


ggplot() +
  geom_polygon(
    data = us_states,
    aes(x = long, y = lat, group = group, fill = as.factor(DD)),
    color = "white", size = 0.3  # Add white borders for better distinction
  ) +
  scale_fill_manual(
    values = map_color_palette,
    labels = c("Not Adopted", "Adopted")
  ) +
  theme_minimal() +
  labs(
    title = "Corporal Punishment Ban Adoption by State",
    subtitle = "States that adopted bans starting in 2020",
    fill = "Ban Status"
  ) +
  theme(
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

```
## Column 

### Interactive map 

```{r}
## utilizing mapbox approach 

# install.packages(c( "sf", "geojsonio"))
library(leaflet)
library(sf)
library(dplyr)
library(geojsonio)  # For converting state shapefiles


library(maps)
library(sf)

# Convert built-in map to sf directly
us_states_sf <- st_as_sf(maps::map("state", plot = FALSE, fill = TRUE))

# Check output
# print(us_states_sf)

# Merge with df_corp (filtering for 2020 and later)
df_corp_filtered <- df3 %>%
  filter(YEAR >= 2020) %>%
  group_by(STATE_CODE)  # Get max DD (0 or 1) per state

# Create a lookup table to map abbreviations to full state names
# state_lookup <- data.frame(STATE_CODE = state.abb, region = tolower(state.name))
# 
# # Merge state names with df_corp_filtered
# 
# 
# df_corp_filtered <- left_join(df_corp_filtered, state_lookup, by = "STATE_CODE")

state_lookup <- data.frame(STATE_CODE = state.abb, region = tolower(state.name))

state_lookup <- state_lookup %>%
  mutate(STATE_CODE = as.character(STATE_CODE), region = as.character(region)) %>%
  bind_rows(data.frame(STATE_CODE = "DC", region = "district of columbia"))

# df_corp_filtered$region <- if_else(is.na(df_corp_filtered$region), "district of columbia", df_corp$region)
df_corp2<- left_join(state_lookup, df_corp_filtered, by = "STATE_CODE")

us_states_sf <- us_states_sf %>%
  rename(region = ID)

# Merge with sf shapefile
us_states_sf2 <- left_join(us_states_sf, df_corp2, by = "region")


# Define color palette
color_palette <- c("0" = "#e5de54",  # Yellow (Not Adopted)
                   "1" = "#808c73")  # Dark Gray (Adopted)

# Create the leaflet map
leaflet(us_states_sf2) %>%
  addTiles() %>%
  setView(lng = -98.5, lat = 39.8, zoom = 4) %>%
  addPolygons(
    fillColor = ~color_palette[as.character(DD)],  # Map DD values to colors
    weight = 1,
    opacity = 1,
    color = "white",
    fillOpacity = 0.8,
    highlightOptions = highlightOptions(
      weight = 3,
      color = c("#e5de54", "#808c73"),
      fillOpacity = 0.9,
      bringToFront = TRUE
    ),
    label = ~paste0(region, ": ", ifelse(DD == 1, "Adopted", "Not Adopted"))
  ) %>%
  addLegend(
    position = "bottomright",
    colors = c("#e5de54", "#808c73"),
    labels = c("Not Adopted", "Adopted"),
    title = "Corporal Punishment Ban Status"
  )
```

```{r}

```



```{r, eval=FALSE}
### Trendline estimates
```

## Column {data-width="350"}

### Policy

```{r, eval=FALSE}

```

### Predictor

```{r, eval=FALSE}

```
