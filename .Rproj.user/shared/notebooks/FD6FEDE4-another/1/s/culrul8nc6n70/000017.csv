"0","# Load Libraries"
"0","library(flexdashboard)"
"0","library(shiny)"
"0","library(ggplot2)"
"0","library(dplyr)"
"0","library(leaflet)"
"0","library(plotly)"
"0","library(sf)"
"0","library(rio)"
"0","library(here)"
"0","library(tidyverse)"
"0",""
"0","# ðŸ“Œ Load Data"
"0","df1 <- import(here(""data/corp_76to20_bystate_MGyearrecoded.xlsx""))"
"0","df2 <- import(here(""data/suspensions_72to21_bystate_MGyearrecoded.xlsx""))"
"0","df3 <- import(here(""data/treatment dataset_2year.xlsx""))"
"0",""
"0","# ðŸ“Œ Fix Missing State Names"
"0","state_lookup <- data.frame(STATE_CODE = state.abb, region = tolower(state.name))"
"0",""
"0","# ðŸ“Œ Convert US states to `sf` object"
"0","us_states_sf <- st_as_sf(maps::map(""state"", fill = TRUE, plot = FALSE)) %>%"
"0","  rename(region = ID) %>%"
"0","  mutate(region = tolower(region)) %>%"
"0","  st_transform(crs = 4326)  # Ensure correct CRS"
"0",""
"0","# ðŸ“Œ Merge data with full state names"
"0","df1 <- left_join(df1, state_lookup, by = ""STATE_CODE"")"
"0","df1$region <- if_else(is.na(df1$region), ""district of columbia"", df1$region)"
"0",""
"0","# ðŸ“Œ Ensure all geometries are valid"
"0","df_join <- left_join(us_states_sf, df1, by = ""region"") %>%"
"0","  st_make_valid() %>%"
"0","  filter(st_is_valid(.))  # Remove invalid geometries"
"0",""
"0","# ðŸ“Œ Convert necessary columns to numeric"
"0","df1 <- df1 %>%"
"0","  mutate("
"0","    ENR_ = as.numeric(ENR_),"
"0","    CORP_ = as.numeric(CORP_),"
"0","    Corporal_Rate = pmax(CORP_ / ENR_, 0) * 100"
"0","  ) %>%"
"0","  replace_na(list(Corporal_Rate = 0))"
"0",""
"0","# ðŸ“Œ Aggregate by year, state, and race"
"0","df_trend <- df1 %>%"
"0","  group_by(YEAR, STATE_CODE, race) %>%"
"0","  summarise(Corporal_Rate = mean(Corporal_Rate, na.rm = TRUE), .groups = ""drop"") %>%"
"0","  mutate(Smoothed_Rate = pmax(0, predict(loess(Corporal_Rate ~ YEAR, span = 0.5, na.action = na.exclude))))"
"0",""
"0","# ðŸ“Œ Define Race Colors"
"0","race_colors <- c("
"0","  ""AI"" = ""#bdbfbf"", ""AS"" = ""#808c73"", ""BL"" = ""#677812"","
"0","  ""HI"" = ""#e5de54"", ""HP"" = ""#a1a1a1"", ""MR"" = ""#303333"", ""WH"" = ""#0c4d1d"""
"0",")"
"0",""
"0","# ðŸ“Œ UI Definition"
"0","ui <- fluidPage("
"0","  titlePanel(""Corporal Punishment Ban Adoption and Trends""),"
"0","  "
"0","  sidebarLayout("
"0","    sidebarPanel("
"0","      h3(""Selected State Statistics""),"
"0","      textOutput(""selected_state""),"
"0","      verbatimTextOutput(""summary_stats"")"
"0","    ),"
"0","    "
"0","    mainPanel("
"0","      plotOutput(""map"", click = ""map_click""),  "
"0","      plotlyOutput(""state_trend"")  "
"0","    )"
"0","  )"
"0",")"
"0",""
"0","# ðŸ“Œ Server Logic"
"0","server <- function(input, output, session) {"
"0","  "
"0","  selected_state <- reactiveVal(NULL)  # Store clicked state"
"0","  "
"0","  # âœ… Fix: Place renderPlot inside server"
"0","  output$map <- renderPlot({"
"0","    ggplot() +"
"0","      geom_sf(data = df_join, aes(fill = as.factor(DD)), color = ""white"", size = 0.3) +"
"0","      scale_fill_manual(values = c(""0"" = ""#e5de54"", ""1"" = ""#808c73""), labels = c(""Not Adopted"", ""Adopted"")) +"
"0","      theme_minimal() +"
"0","      labs(title = ""Corporal Punishment Ban Adoption by State"", fill = ""Ban Status"") +"
"0","      theme(axis.text = element_blank(), axis.ticks = element_blank(), panel.grid = element_blank())"
"0","  })"
"0","  "
"0","  # âœ… Fix: Ensure `input$map_click` is used **inside observeEvent()**"
"0","  observeEvent(input$map_click, {"
"0","    req(input$map_click)  # Ensure click event exists"
"0",""
"0","    clicked_point <- st_sfc(st_point(c(input$map_click$x, input$map_click$y)), crs = st_crs(df_join))"
"0","    clicked_point <- st_as_sf(clicked_point)"
"0",""
"0","    nearest_state_index <- st_nearest_feature(clicked_point, df_join)"
"0","    clicked_state <- df_join$region[nearest_state_index]"
"0",""
"0","    if (!is.null(clicked_state)) {"
"0","      selected_state(clicked_state)  # Store selected state"
"0","    }"
"0","  })"
"0","  "
"0","  # âœ… Fix: Ensure selected state is displayed only if valid"
"0","  output$selected_state <- renderText({"
"0","    req(selected_state())"
"0","    paste(""Selected State:"", selected_state())"
"0","  })"
"0","  "
"0","  # âœ… Fix: Ensure summary statistics only render after selection"
"0","  output$summary_stats <- renderPrint({"
"0","    req(selected_state())"
"0","    state_data <- df1 %>% filter(STATE_CODE == selected_state())"
"0","    summary(state_data$Corporal_Rate)"
"0","  })"
"0","  "
"0","  # âœ… Fix: Ensure plotly chart updates reactively"
"0","  output$state_trend <- renderPlotly({"
"0","    req(selected_state())"
"0","    "
"0","    state_data <- df_trend %>% filter(toupper(STATE_CODE) == toupper(selected_state()))"
"0","    "
"0","    plot_ly(state_data, x = ~YEAR, y = ~Smoothed_Rate, color = ~race, colors = race_colors, type = ""scatter"", mode = ""lines"") %>%"
"0","      layout(title = paste(""Corporal Punishment Rates in"", selected_state()),"
"0","             xaxis = list(title = ""Year""),"
"0","             yaxis = list(title = ""Corporal Punishment Rate (%)"", range = c(0, NA)),"
"0","             legend = list(title = list(text = ""Race"")))"
"0","  })"
"0","}"
"0",""
"0","ui <- fluidPage("
"0","  titlePanel(""Corporal Punishment Ban Adoption and Trends""),"
"0","  "
"0","  sidebarLayout("
"0","    sidebarPanel("
"0","      h3(""Selected State Statistics""),"
"0","      textOutput(""selected_state""),"
"0","      verbatimTextOutput(""summary_stats"")"
"0","    ),"
"0","    "
"0","    mainPanel("
"0","      plotOutput(""map"", click = ""map_click""),  # âœ… Clickable Static Map"
"0","      plotlyOutput(""state_trend"")  # âœ… Interactive Trend Plot"
"0","    )"
"0","  )"
"0",")"
"0",""
"0","# Run Shiny App"
"0","shinyApp(ui, server)"
"2","
Listening on http://127.0.0.1:7614
"
"2","  206: [37m<Anonymous>[39m
"
"2",""
"2","  205: [37msignalCondition[39m
"
"2",""
"2","  204: [37msignal_abort[39m
"
"2",""
"2","  203: [37mrlang::abort[39m
"
"2",""
"2","  202: [37mcli::cli_abort[39m
"
"2",""
"2","  201: [37mhandlers[[1L]][39m
"
"2",""
"2","  200: [37mh[39m
"
"2",""
"2","  199: [37m.handleSimpleError[39m
"
"2",""
"2","  198: [37mis.factor[39m
"
"2",""
"2","  197: [37mas.factor[39m
"
"2",""
"2","  196: [37mFUN[39m
"
"2",""
"2","  195: [37mlapply[39m
"
"2",""
"2","  194: [37mcompute_aesthetics[39m
"
"2",""
"2","  193: [37ml$compute_aesthetics[39m
"
"2",""
"2","  192: [37mf[39m
"
"2",""
"2","  185: [37mby_layer[39m
"
"2",""
"2","  184: [37mggplot_build.ggplot[39m
"
"2",""
"2","  182: [37mprint.ggplot[39m
"
"2",""
"2","  177: [37mfunc[39m
"
"2",""
"2","  175: [37mf[39m
"
"2",""
"2","  174: [37mReduce[39m
"
"2",""
"2","  165: [37mdo[39m
"
"2",""
"2","  164: [37mhybrid_chain[39m
"
"2",""
"2","  136: [37mdrawPlot[39m
"
"2",""
"2","  122: [37m<reactive:plotObj>[39m
"
"2",""
"2","  102: [37mdrawReactive[39m
"
"2",""
"2","   89: [37mrenderFunc[39m
"
"2",""
"2","   88: [37moutput$map[39m
"
"2",""
"2","    3: [37mrunApp[39m
"
"2",""
"2","    2: [37mprint.shiny.appobj[39m
"
"2",""
"2","    1: [37m<Anonymous>[39m
"
